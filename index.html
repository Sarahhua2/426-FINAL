<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>Node Management</title>
</head>
<body>
    <h1>Task Manager</h1>
    <table id="quotesTable">
        <tbody>

        </tbody>
    </table>
    <button id="getQuoteButton" class="btn">Get Random Quote</button>
    <!-- Form to create a new node -->
    <h2>Create task</h2>
    <form id="createForm">
        <label for="headline">Headline:</label>
        <input type="text" id="headline" name="headline" required><br><br>
        <label for="note">Note:</label>
        <textarea id="note" name="note" required></textarea><br><br>
        <button type="submit" class="btn">Add</button>
    </form>
    
    <!-- Table to display existing nodes -->
    <h2>Current Tasks</h2>
    <table id="nodesTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Headline</th>
                <th>Note</th>
                <th>Edit</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody>
            <!-- Nodes will be dynamically added here -->
        </tbody>
    </table>
    
    <script>
        let port = 5500;
        let host = 'localhost';
        const quoteAPI = "https://type.fit/api/quotes";
        // let host = '127.0.0.1'
        // Function to fetch and display nodes
        
        async function fetchQuotes() {
            
            try {
            const response = await fetch("http://" + host + ":" + port + "/quotes");
            if (!response.ok) {
                throw new Error("Failed to fetch quotes");
                }
            
            const quotes = await response.json();
            // console.log(quote); // Log the parsed JSON data
            const quotesTable = document.getElementById('quotesTable').getElementsByTagName('tbody')[0];
            
            quotesTable.innerHTML = ''; // Clear previous nodes

            quotes.forEach(quote => {
                const row = quotesTable.insertRow();
                row.innerHTML = `
                    <td>${quote.text}</td>
                    <td><button class="btn" onclick="deleteQuote(${quote.id})">Delete</button></td>
                `;
            });
            }
            catch (error) {
                console.error("Error fetching quotes:", error);
            }
        }

        async function getRandomQuote() {
            const response = await fetch(quoteAPI);
            let data = await response.json();

            let random_number = Math.floor(Math.random() * (16 - 0 + 1)) + 0;
            console.log(random_number);
            console.log(data[random_number]);
            let responseData = data[random_number];
            // let responseData = {text: quote.text, author: quote.author };
            // console.log(responseData);
            const quote = await fetch("http://" + host + ":" + port + "/quotes", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(responseData)
            });
            if (quote.ok) {
                fetchQuotes();
            } else {
                alert('Failed to create node');
            }

        }

        async function deleteQuote(id) {
            const response = await fetch("http://" + host + ":" + port + "/quotes/" + id, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    console.log('refreshing table');
                    fetchQuotes(); // Refresh the nodes table
                } else {
                    alert('Failed to delete node');
                }
        }
                
        async function fetchNodes() {
            
            try {
            const response = await fetch("http://" + host + ":" + port + "/nodes");
            if (!response.ok) {
                throw new Error("Failed to fetch nodes");
            }
            const nodes = await response.json();
            console.log(nodes); // Log the parsed JSON data
            const nodesTable = document.getElementById('nodesTable').getElementsByTagName('tbody')[0];
            
            nodesTable.innerHTML = ''; // Clear previous nodes

            nodes.forEach(node => {
                console.log(typeof(node));
                const row = nodesTable.insertRow();
                row.innerHTML = `
                    <td>${node.id}</td>
                    <td>${node.headline}</td>
                    <td>${node.note}</td>
                    <td><button class="btn" onclick="editNode(${node.id})">Edit</button></td>
                    <td><button class="btn" onclick="deleteNode(${node.id})">Delete</button></td>
                `;
            });
       
            } catch (error) {
                console.error("Error fetching nodes:", error);
            }
            
        }
        
        // Function to create a new node
        async function createNode(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const responseData = {};
            
            formData.forEach((value, key) => {
                responseData[key] = value;
            });
            
            const response = await fetch("http://" + host + ":" + port + "/nodes", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(responseData)
            });
            
            if (response.ok) {
                fetchNodes(); // Refresh the nodes table
                form.reset(); // Clear the form fields
            } else {
                alert('Failed to create node');
            }
        }
        
        // Function to delete a node
        async function deleteNode(id) {
            const confirmed = confirm('Are you sure you want to delete this node?');
            if (confirmed) {
                const response = await fetch("http://" + host + ":" + port + "/nodes/" + id, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    console.log('refreshing table');
                    fetchNodes(); // Refresh the nodes table
                } else {
                    alert('Failed to delete node');
                }
            }
        }
        
        // Function to edit a node (redirect to edit page or modal)
        function editNode(id) {
            fetch("http://" + host + ":" + port + "/nodes/" + id)
    .then(res => res.json())
    .then(node => {
      const nodesTable = document.getElementById("nodesTable");
      const newRow = nodesTable.insertRow();
      newRow.classList.add("edit-row"); // Add a class for styling

      // Create edit form elements
      const editForm = document.createElement("form");
      editForm.setAttribute("id", `edit-form-${id}`);

      const headlineLabel = document.createElement("label");
      headlineLabel.textContent = "Headline:";
      const headlineInput = document.createElement("input");
      headlineInput.setAttribute("type", "text");
      headlineInput.setAttribute("name", "headline");
      headlineInput.setAttribute("value", node.headline);

      const noteLabel = document.createElement("label");
      noteLabel.textContent = "Note:";
      const noteInput = document.createElement("textarea");
      noteInput.setAttribute("name", "note");
      noteInput.textContent = node.note;

      const updateButton = document.createElement("button");
      updateButton.setAttribute("type", "submit");
      updateButton.classList.add("btn");
      updateButton.textContent = "Update";

      // Add elements to the form and new row
      editForm.appendChild(headlineLabel);
      editForm.appendChild(headlineInput);
      editForm.appendChild(noteLabel);
      editForm.appendChild(noteInput);
      editForm.appendChild(updateButton);

      const editCell = newRow.insertCell();
      editCell.colSpan = 5; // Span across all columns
      editCell.appendChild(editForm);

      // Add event listener for form submission (update)
      editForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const formData = new FormData(editForm);
        const updatedData = {};
        formData.forEach((value, key) => (updatedData[key] = value));

        // Call PUT API with updated data
        fetch("http://" + host + ":" + port + "/nodes/" + id, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(updatedData),
        })
          .then((res) => {
            if (res.ok) {
              // Clear edit form and refresh table on success
              newRow.remove();
              fetchNodes();
            } else {
              alert("Failed to update node");
            }
          })
          .catch((error) => console.error("Error updating node:", error));
      });
    })
    .catch((error) => console.error("Error fetching node:", error));

            console.log(`Editing node with ID: ${id}`);
        }
        // Event listener for get quote button
        document.getElementById('getQuoteButton').addEventListener('click', getRandomQuote);
        // Event listener for form submission
        document.getElementById('createForm').addEventListener('submit', createNode);
        
        // Fetch and display nodes when the page loads
        
        fetchNodes();
    </script>
</body>
</html>
